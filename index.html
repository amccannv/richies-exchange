<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="favicon/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="favicon/favicon.svg" />
    <link rel="shortcut icon" href="favicon/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="favicon/apple-touch-icon.png" />
    <link rel="manifest" href="favicon/site.webmanifest" />
    <title>Richie's Exchange</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a2e;
            color: #eee;
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { text-align: center; margin-bottom: 10px; color: #f0b90b; }
        .subtitle { text-align: center; color: #888; margin-bottom: 20px; }
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        input, select {
            padding: 10px 15px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            background: #2d2d44;
            color: #fff;
        }
        input { flex: 1; min-width: 200px; }
        input:focus, select:focus { outline: 2px solid #f0b90b; }
        .stats {
            background: #2d2d44;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
        }
        .stat-item { }
        .stat-label { color: #888; font-size: 12px; }
        .stat-value { font-size: 18px; font-weight: bold; color: #f0b90b; }
        table {
            width: 100%;
            border-collapse: collapse;
            background: #2d2d44;
            border-radius: 8px;
            overflow: hidden;
        }
        th, td { padding: 12px 15px; text-align: left; }
        th { background: #3d3d54; font-weight: 600; cursor: pointer; }
        th:hover { background: #4d4d64; }
        tr:nth-child(even) { background: #252538; }
        tr:hover { background: #353548; }
        .gp { color: #f0b90b; }
        .local-currency { color: #4CAF50; font-weight: 600; }
        .loading { text-align: center; padding: 40px; color: #888; }
        .error { color: #ff6b6b; text-align: center; padding: 20px; }
        
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .modal-overlay.active { display: flex; }
        .modal {
            background: #2d2d44;
            border-radius: 12px;
            padding: 20px;
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow: auto;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .modal-title { font-size: 20px; font-weight: bold; color: #f0b90b; display: flex; align-items: center; gap: 10px; }
        .modal-title img { width: 28px; height: 28px; object-fit: contain; }
        .modal-close {
            background: none;
            border: none;
            color: #888;
            font-size: 28px;
            cursor: pointer;
            line-height: 1;
        }
        .modal-close:hover { color: #fff; }
        .modal-content-grid { display: flex; gap: 20px; align-items: flex-start; }
        .modal-chart-wrapper { flex: 1; min-width: 0; }
        .chart-container { position: relative; height: 400px; }
        .modal-stats { display: flex; gap: 20px; margin-top: 15px; flex-wrap: wrap; }
        .modal-stat { }
        .modal-stat-label { color: #888; font-size: 12px; }
        .modal-stat-value { font-size: 16px; font-weight: bold; color: #4CAF50; }
        .item-row { cursor: pointer; }
        .item-row:hover { background: #404060 !important; }
        .item-name-cell { display: flex; align-items: center; gap: 10px; }
        .item-thumb { width: 28px; height: 28px; object-fit: contain; flex-shrink: 0; }
        .per-wrapper { 
            white-space: nowrap;
        }
        .per-label { 
            color: #888; 
            font-size: 11px; 
            font-weight: normal;
        }
        .per-value { 
            color: #888; 
            font-size: 11px; 
            font-weight: normal;
            cursor: pointer;
        }
        .per-value:hover { 
            color: #4CAF50; 
        }
        .multiplier-badge { 
            background: #f0b90b; 
            color: #1a1a2e; 
            padding: 2px 6px; 
            border-radius: 4px; 
            font-size: 11px; 
            font-weight: bold;
            margin-left: 4px;
            cursor: pointer;
        }
        .multiplier-badge:hover { 
            background: #ffcc00; 
        }
        .modal-loading { text-align: center; padding: 100px 0; color: #888; }
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
        }
        .pagination button {
            padding: 8px 16px;
            background: #2d2d44;
            border: none;
            border-radius: 6px;
            color: #fff;
            cursor: pointer;
        }
        .pagination button:hover { background: #3d3d54; }
        .pagination button:disabled { opacity: 0.5; cursor: not-allowed; }
        .pagination-info { color: #888; }
        
        .sort-control {
            display: flex;
            justify-content: flex-end;
            align-items: flex-start;
            gap: 15px;
            position: relative;
            margin-bottom: 10px;
        }
        .currency-control {
            position: relative;
        }
        .currency-control .sort-dropdown {
            right: auto;
            left: 0;
        }
        .sort-toggle {
            background: transparent;
            border: none;
            color: #888;
            font-size: 12px;
            cursor: pointer;
            padding: 4px 8px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .sort-toggle:hover { color: #fff; }
        .sort-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background: #2d2d44;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 100;
            min-width: 120px;
            overflow: hidden;
        }
        .sort-dropdown.active { display: block; }
        .sort-dropdown div {
            padding: 8px 12px;
            cursor: pointer;
            font-size: 13px;
            color: #ccc;
        }
        .sort-dropdown div:hover { background: #3d3d54; color: #fff; }
        
        @media (max-width: 768px) {
            body { padding: 10px; }
            h1 { font-size: 22px; }
            .controls { gap: 10px; }
            input { min-width: 100%; }
            select { flex: 1; }
            .stats { gap: 15px; padding: 12px; }
            .stat-value { font-size: 16px; }
            table { font-size: 13px; }
            th, td { padding: 8px 6px; }
            .modal { padding: 15px; border-radius: 8px; }
            .modal-title { font-size: 16px; }
            .modal-content-grid { flex-direction: column; align-items: center; }
            .modal-image { width: 150px; }
            .chart-container { height: 250px; }
            .modal-stats { gap: 12px; }
            .modal-stat-value { font-size: 14px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Richie's Exchange</h1>
        <p class="subtitle" id="lastUpdate">Loading prices...</p>
        
        <div class="controls">
            <input type="text" id="search" placeholder="Search items...">
            <select id="currency" style="display:none;">
                <option value="CAD">CAD ($)</option>
                <option value="USD">USD ($)</option>
                <option value="GBP">GBP (£)</option>
                <option value="EUR">EUR (€)</option>
                <option value="AUD">AUD ($)</option>
                <option value="BRL">BRL (R$)</option>
                <option value="DKK">DKK (kr.)</option>
                <option value="SEK">SEK (kr)</option>
            </select>
        </div>

        <div class="stats">
            <div class="stat-item">
                <div class="stat-label">Bond Price (GP)</div>
                <div class="stat-value" id="bondPrice">-</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">GP per 1 <span id="currencySymbol">$</span></div>
                <div class="stat-value" id="gpPerUnit">-</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">Items Loaded</div>
                <div class="stat-value" id="itemCount">-</div>
            </div>
        </div>

        <div id="loading" class="loading">Fetching Grand Exchange prices...</div>
        <div id="error" class="error" style="display:none;"></div>
        <div class="sort-control">
            <div class="currency-control">
                <button id="currencyToggle" class="sort-toggle">
                    <span id="currencyLabel">CAD $</span>
                </button>
                <div id="currencyDropdown" class="sort-dropdown">
                    <div data-currency="CAD">CAD $</div>
                    <div data-currency="USD">USD $</div>
                    <div data-currency="GBP">GBP £</div>
                    <div data-currency="EUR">EUR €</div>
                    <div data-currency="AUD">AUD $</div>
                    <div data-currency="BRL">BRL R$</div>
                    <div data-currency="DKK">DKK kr.</div>
                    <div data-currency="SEK">SEK kr</div>
                </div>
            </div>
            <button id="sortToggle" class="sort-toggle">
                <span id="sortLabel">Volume ↓</span>
            </button>
            <div id="sortDropdown" class="sort-dropdown">
                <div data-sort="volume" data-dir="desc">Volume ↓</div>
                <div data-sort="volume" data-dir="asc">Volume ↑</div>
                <div data-sort="gp" data-dir="desc">Price ↓</div>
                <div data-sort="gp" data-dir="asc">Price ↑</div>
            </div>
        </div>
        <div class="table-wrapper">
            <table id="itemsTable" style="display:none;">
                <thead>
                    <tr>
                        <th>Item Name</th>
                        <th>GP Price</th>
                        <th>Local Currency</th>
                    </tr>
                </thead>
                <tbody id="itemsBody"></tbody>
            </table>
        </div>
        <div class="pagination" id="pagination" style="display:none;">
            <button id="prevPage">&larr; Prev</button>
            <span class="pagination-info" id="pageInfo"></span>
            <button id="nextPage">Next &rarr;</button>
        </div>
    </div>

    <div class="modal-overlay" id="modal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">Item Name</div>
                <button class="modal-close" id="modalClose">&times;</button>
            </div>
            <div id="modalContent">
                <div class="modal-loading">Loading price history...</div>
            </div>
        </div>
    </div>

    <script>
        const BOND_REAL_PRICES = {
            USD: { price: 8.99, symbol: '$' },
            GBP: { price: 6.49, symbol: '£' },
            EUR: { price: 7.99, symbol: '€' },
            CAD: { price: 11.49, symbol: '$' },
            AUD: { price: 12.99, symbol: '$' },
            BRL: { price: 21.99, symbol: 'R$' },
            DKK: { price: 57.00, symbol: 'kr.' },
            SEK: { price: 77.00, symbol: 'kr' }
        };

        let allItems = [];
        let bondPrice = 0;
        let currentPage = 1;
        const pageSize = 50;
        let itemImages = {};
        let sortBy = 'volume';
        let sortDirection = 'desc';

        async function loadImages() {
            try {
                const response = await fetch('item_images.json');
                itemImages = await response.json();
            } catch (e) {
                console.log('No item images loaded');
            }
        }

        async function loadData() {
            try {
                const response = await fetch('https://chisel.weirdgloop.org/gazproj/gazbot/rs_dump.json');
                const data = await response.json();
                
                const timestamp = data['%JAGEX_TIMESTAMP%'];
                if (timestamp) {
                    const date = new Date(timestamp * 1000);
                    document.getElementById('lastUpdate').textContent = `Last updated: ${date.toLocaleString('en-CA', { dateStyle: 'medium', timeStyle: 'short' })}`;
                }
                
                allItems = Object.entries(data)
                    .filter(([key]) => !key.startsWith('%'))
                    .map(([id, item]) => ({ 
                        name: item.name, 
                        gp: item.price || 0, 
                        volume: item.volume || 0 
                    }));
                
                const bond = allItems.find(i => i.name === 'Bond');
                bondPrice = bond ? bond.gp : 115879148;
                document.getElementById('bondPrice').textContent = bondPrice.toLocaleString();
                
                document.getElementById('itemCount').textContent = allItems.length.toLocaleString();
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('itemsTable').style.display = 'table';
                
                renderItems();
            } catch (err) {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                document.getElementById('error').textContent = 'Failed to load prices: ' + err.message;
            }
        }

        function gpToLocal(gp, currency) {
            return gp * (BOND_REAL_PRICES[currency].price / bondPrice);
        }

        function formatGP(gp) {
            return gp.toLocaleString() + ' gp';
        }

        const itemMultipliers = {};

        function parseMultiplier(str) {
            if (!str) return null;
            str = str.trim().toLowerCase();
            if (!str) return null;
            
            const multipliers = { 'k': 1000, 'm': 1000000, 'b': 1000000000 };
            const lastChar = str.slice(-1);
            
            if (multipliers[lastChar]) {
                const num = parseFloat(str.slice(0, -1));
                return isNaN(num) ? null : num * multipliers[lastChar];
            }
            
            const num = parseFloat(str);
            return isNaN(num) || num <= 0 ? null : num;
        }

        function needsMultiplier(amount) {
            return amount > 0 && amount < 0.10;
        }

        function getDefaultMultiplier(amount) {
            if (amount <= 0 || amount >= 0.10) return null;
            return Math.pow(10, Math.ceil(Math.log10(0.10 / amount)));
        }

        function formatLocal(amount, currency, multiplier = null) {
            const info = BOND_REAL_PRICES[currency];
            const displayAmount = multiplier ? amount * multiplier : amount;
            return info.symbol + displayAmount.toLocaleString(undefined, { 
                minimumFractionDigits: 2,
                maximumFractionDigits: 2 
            });
        }

        function getFilteredAndSortedItems() {
            const search = document.getElementById('search').value.toLowerCase();
            const currency = document.getElementById('currency').value;
            
            let filtered = allItems.filter(item => 
                item.name.toLowerCase().includes(search)
            );
            
            filtered = filtered.map(item => ({
                ...item,
                local: gpToLocal(item.gp, currency)
            }));
            
            if (sortBy === 'volume') {
                filtered.sort((a, b) => sortDirection === 'desc' ? b.volume - a.volume : a.volume - b.volume);
            } else {
                filtered.sort((a, b) => sortDirection === 'desc' ? b.gp - a.gp : a.gp - b.gp);
            }
            
            return filtered;
        }

        function renderItems() {
            const currency = document.getElementById('currency').value;
            const items = getFilteredAndSortedItems();
            
            const sortNames = { 'volume': 'Volume', 'gp': 'Price' };
            const arrow = sortDirection === 'desc' ? '↓' : '↑';
            document.getElementById('sortLabel').textContent = `${sortNames[sortBy]} ${arrow}`;
            
            const currencyInfo = BOND_REAL_PRICES[currency];
            document.getElementById('currencyLabel').textContent = `${currency} ${currencyInfo.symbol}`;
            
            const gpPerUnit = bondPrice / currencyInfo.price;
            document.getElementById('gpPerUnit').textContent = Math.round(gpPerUnit).toLocaleString();
            document.getElementById('currencySymbol').textContent = currencyInfo.symbol;
            
            const totalPages = Math.ceil(items.length / pageSize);
            if (currentPage > totalPages) currentPage = Math.max(1, totalPages);
            
            const start = (currentPage - 1) * pageSize;
            const pageItems = items.slice(start, start + pageSize);
            
            const tbody = document.getElementById('itemsBody');
            tbody.innerHTML = pageItems.map(item => {
                const imgSrc = itemImages[item.name];
                const imgHtml = imgSrc ? `<img src="${imgSrc}" alt="${item.name}" class="item-thumb" onerror="this.style.display='none'">` : '<span class="item-thumb"></span>';
                const showMultiplier = needsMultiplier(item.local);
                const multiplier = itemMultipliers[item.name] || null;
                const defaultMult = getDefaultMultiplier(item.local);
                const displayMultiplier = multiplier || (showMultiplier ? defaultMult : null);
                const priceDisplay = formatLocal(item.local, currency, displayMultiplier);
                const perText = displayMultiplier ? ` <span class="per-wrapper"><span class="per-label">per</span> <span class="per-value multiplier-trigger" data-item="${item.name.replace(/"/g, '&quot;')}" title="Click to change quantity">${displayMultiplier.toLocaleString()}</span></span>` : '';
                return `
                <tr class="item-row" data-name="${item.name.replace(/"/g, '&quot;')}" data-volume="${item.volume}">
                    <td><div class="item-name-cell">${imgHtml}${item.name}</div></td>
                    <td class="gp">${formatGP(item.gp)}</td>
                    <td class="local-currency">${priceDisplay}${perText}</td>
                </tr>
            `}).join('');
            
            document.querySelectorAll('.multiplier-trigger').forEach(perValue => {
                perValue.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const itemName = perValue.dataset.item;
                    const currentVal = itemMultipliers[itemName] || '';
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.className = 'multiplier-input';
                    input.value = currentVal;
                    input.placeholder = '1k';
                    input.style.cssText = 'width:35px;max-width:35px;min-width:35px;font-size:11px;padding:0 1px;border:none;border-radius:3px;background:transparent;color:#4CAF50;font-weight:normal;text-align:center;outline:none;display:inline-block;box-sizing:border-box;';
                    
                    perValue.replaceWith(input);
                    input.focus();
                    input.select();
                    
                    const applyMultiplier = () => {
                        const val = parseMultiplier(input.value);
                        if (val) {
                            itemMultipliers[itemName] = val;
                        } else {
                            delete itemMultipliers[itemName];
                        }
                        renderItems();
                    };
                    
                    input.addEventListener('blur', applyMultiplier);
                    input.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            applyMultiplier();
                        }
                        if (e.key === 'Escape') {
                            renderItems();
                        }
                    });
                });
            });
            
            document.querySelectorAll('.item-row').forEach(row => {
                row.addEventListener('click', () => openModal(row.dataset.name, parseInt(row.dataset.volume)));
            });
            
            const pagination = document.getElementById('pagination');
            if (items.length > pageSize) {
                pagination.style.display = 'flex';
                document.getElementById('prevPage').disabled = currentPage === 1;
                document.getElementById('nextPage').disabled = currentPage === totalPages;
                document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages} (${items.length.toLocaleString()} items)`;
            } else {
                pagination.style.display = 'none';
            }
        }
        
        document.getElementById('prevPage').addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                renderItems();
            }
        });
        
        document.getElementById('nextPage').addEventListener('click', () => {
            const items = getFilteredAndSortedItems();
            const totalPages = Math.ceil(items.length / pageSize);
            if (currentPage < totalPages) {
                currentPage++;
                renderItems();
            }
        });

        let priceChart = null;
        const historyCache = {};
        let bondHistoryMap = null;

        async function getBondHistoryMap() {
            if (bondHistoryMap) return bondHistoryMap;
            
            try {
                const response = await fetch('https://api.weirdgloop.org/exchange/history/rs/all?name=Bond');
                const data = await response.json();
                const bondHistory = data['Bond'] || [];
                bondHistoryMap = new Map(bondHistory.map(d => [d.timestamp, d.price]));
                return bondHistoryMap;
            } catch (e) {
                return null;
            }
        }

        function gpToLocalHistorical(gp, currency, bondPriceAtTime) {
            const bondPriceToUse = bondPriceAtTime || bondPrice;
            return gp * (BOND_REAL_PRICES[currency].price / bondPriceToUse);
        }

        async function openModal(itemName, volume) {
            const modal = document.getElementById('modal');
            const title = document.getElementById('modalTitle');
            const content = document.getElementById('modalContent');
            
            const imgHtml = itemImages[itemName] ? `<img src="${itemImages[itemName]}" alt="${itemName}" onerror="this.style.display='none'">` : '';
            title.innerHTML = `${imgHtml}${itemName}`;
            content.innerHTML = '<div class="modal-loading">Loading price history...</div>';
            modal.classList.add('active');
            
            try {
                const [itemResult, bondMap] = await Promise.all([
                    (async () => {
                        if (historyCache[itemName]) return historyCache[itemName];
                        const response = await fetch(`https://api.weirdgloop.org/exchange/history/rs/all?name=${encodeURIComponent(itemName)}`);
                        const data = await response.json();
                        const history = data[itemName] || [];
                        historyCache[itemName] = history;
                        return history;
                    })(),
                    getBondHistoryMap()
                ]);
                
                const historyData = itemResult;
                
                if (historyData.length === 0) {
                    content.innerHTML = '<div class="modal-loading">No historical data available</div>';
                    return;
                }
                
                const currency = document.getElementById('currency').value;
                const currencyInfo = BOND_REAL_PRICES[currency];
                
                const labels = historyData.map(d => {
                    const date = new Date(d.timestamp);
                    return date.toLocaleDateString('en-CA', { month: 'short', year: '2-digit' });
                });
                const prices = itemName === 'Bond' 
                    ? historyData.map(() => currencyInfo.price)
                    : historyData.map(d => {
                        const bondPriceAtTime = bondMap ? bondMap.get(d.timestamp) : null;
                        return gpToLocalHistorical(d.price, currency, bondPriceAtTime);
                    });
                
                const currentPrice = prices[prices.length - 1];
                const firstPrice = prices[0];
                const minPrice = Math.min(...prices);
                const maxPrice = Math.max(...prices);
                const change = ((currentPrice - firstPrice) / firstPrice * 100).toFixed(1);
                const showMultiplier = needsMultiplier(currentPrice);
                const multiplier = itemMultipliers[itemName] || null;
                const defaultMult = getDefaultMultiplier(currentPrice);
                const displayMultiplier = multiplier || (showMultiplier ? defaultMult : null);
                const perText = displayMultiplier ? ` <span class="per-wrapper"><span class="per-label">per</span> <span class="per-value multiplier-modal-trigger" title="Click to change quantity">${displayMultiplier.toLocaleString()}</span></span>` : '';
                
                title.innerHTML = `${imgHtml}${itemName}`;
                
                const perLabelEl = null;
                
                content.innerHTML = `
                    <div class="modal-content-grid">
                        <div class="modal-chart-wrapper">
                            <div class="chart-container">
                                <canvas id="priceChart"></canvas>
                            </div>
                            <div class="modal-stats">
                        <div class="modal-stat">
                            <div class="modal-stat-label">Current</div>
                            <div class="modal-stat-value">${formatLocal(currentPrice, currency, displayMultiplier)}${perText}</div>
                        </div>
                        <div class="modal-stat">
                            <div class="modal-stat-label">All-Time High</div>
                            <div class="modal-stat-value">${formatLocal(maxPrice, currency, displayMultiplier)}</div>
                        </div>
                        <div class="modal-stat">
                            <div class="modal-stat-label">All-Time Low</div>
                            <div class="modal-stat-value">${formatLocal(minPrice, currency, displayMultiplier)}</div>
                        </div>
                        <div class="modal-stat">
                            <div class="modal-stat-label">All-Time Change</div>
                            <div class="modal-stat-value" style="color: ${change >= 0 ? '#4CAF50' : '#ff6b6b'}">${change}%</div>
                        </div>
                        <div class="modal-stat">
                            <div class="modal-stat-label">Daily Volume</div>
                            <div class="modal-stat-value">${volume.toLocaleString()}</div>
                        </div>
                        <div class="modal-stat">
                            <div class="modal-stat-label">Data Points</div>
                            <div class="modal-stat-value">${historyData.length.toLocaleString()}</div>
                        </div>
                            </div>
                        </div>
                    </div>
                `;
                
                const displayPrices = displayMultiplier ? prices.map(p => p * displayMultiplier) : prices;
                
                if (priceChart) priceChart.destroy();
                
                const ctx = document.getElementById('priceChart').getContext('2d');
                priceChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: `Price (${currencyInfo.symbol}${displayMultiplier ? ' per ' + displayMultiplier.toLocaleString() : ''})`,
                            data: displayPrices,
                            borderColor: '#f0b90b',
                            backgroundColor: 'rgba(240, 185, 11, 0.1)',
                            fill: true,
                            tension: 0.1,
                            pointRadius: 0,
                            pointHoverRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: { intersect: false, mode: 'index' },
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                displayColors: false,
                                callbacks: {
                                    label: (ctx) => formatLocal(ctx.raw, currency)
                                }
                            }
                        },
                        scales: {
                            x: { 
                                grid: { color: '#3d3d54' },
                                ticks: { 
                                    color: '#888',
                                    maxTicksLimit: 12
                                }
                            },
                            y: { 
                                grid: { color: '#3d3d54' },
                                ticks: { 
                                    color: '#888',
                                    callback: (v) => formatLocal(v, currency)
                                }
                            }
                        }
                    }
                });
                
                const modalPerValue = content.querySelector('.multiplier-modal-trigger');
                if (modalPerValue) {
                    modalPerValue.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const currentVal = itemMultipliers[itemName] || '';
                        const input = document.createElement('input');
                        input.type = 'text';
                        input.className = 'multiplier-input';
                        input.value = currentVal;
                        input.placeholder = '1k';
                        input.style.cssText = 'width:35px;max-width:35px;min-width:35px;font-size:11px;padding:0 1px;border:none;border-radius:3px;background:transparent;color:#4CAF50;font-weight:normal;text-align:center;outline:none;display:inline-block;box-sizing:border-box;';
                        
                        modalPerValue.replaceWith(input);
                        input.focus();
                        input.select();
                        
                        const applyMultiplier = () => {
                            const val = parseMultiplier(input.value);
                            if (val) {
                                itemMultipliers[itemName] = val;
                            } else {
                                delete itemMultipliers[itemName];
                            }
                            openModal(itemName, volume);
                        };
                        
                        input.addEventListener('blur', applyMultiplier);
                        input.addEventListener('keydown', (e) => {
                            if (e.key === 'Enter') {
                                e.preventDefault();
                                applyMultiplier();
                            }
                            if (e.key === 'Escape') {
                                openModal(itemName, volume);
                            }
                        });
                    });
                }
            } catch (err) {
                content.innerHTML = `<div class="modal-loading">Failed to load history: ${err.message}</div>`;
            }
        }

        document.getElementById('modalClose').addEventListener('click', () => {
            document.getElementById('modal').classList.remove('active');
        });
        document.getElementById('modal').addEventListener('click', (e) => {
            if (e.target.id === 'modal') {
                document.getElementById('modal').classList.remove('active');
            }
        });
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                document.getElementById('modal').classList.remove('active');
            }
        });

        if (localStorage.getItem('gme_currency')) {
            document.getElementById('currency').value = localStorage.getItem('gme_currency');
        }
        if (localStorage.getItem('gme_sortBy')) {
            sortBy = localStorage.getItem('gme_sortBy');
        }
        if (localStorage.getItem('gme_sortDir')) {
            sortDirection = localStorage.getItem('gme_sortDir');
        }

        document.getElementById('search').addEventListener('input', () => {
            currentPage = 1;
            renderItems();
        });
        document.getElementById('currency').addEventListener('change', () => {
            localStorage.setItem('gme_currency', document.getElementById('currency').value);
            renderItems();
            const modal = document.getElementById('modal');
            const title = document.getElementById('modalTitle');
            if (modal.classList.contains('active')) {
                const item = allItems.find(i => i.name === title.textContent);
                openModal(title.textContent, item ? item.volume : 0);
            }
        });
        
        document.getElementById('currencyToggle').addEventListener('click', (e) => {
            e.stopPropagation();
            document.getElementById('currencyDropdown').classList.toggle('active');
            document.getElementById('sortDropdown').classList.remove('active');
        });
        
        document.querySelectorAll('#currencyDropdown div').forEach(option => {
            option.addEventListener('click', (e) => {
                e.stopPropagation();
                document.getElementById('currency').value = option.dataset.currency;
                localStorage.setItem('gme_currency', option.dataset.currency);
                document.getElementById('currencyDropdown').classList.remove('active');
                renderItems();
                const modal = document.getElementById('modal');
                const title = document.getElementById('modalTitle');
                if (modal.classList.contains('active')) {
                    const item = allItems.find(i => i.name === title.textContent);
                    openModal(title.textContent, item ? item.volume : 0);
                }
            });
        });
        
        document.getElementById('sortToggle').addEventListener('click', (e) => {
            e.stopPropagation();
            document.getElementById('sortDropdown').classList.toggle('active');
            document.getElementById('currencyDropdown').classList.remove('active');
        });
        
        document.querySelectorAll('#sortDropdown div').forEach(option => {
            option.addEventListener('click', (e) => {
                e.stopPropagation();
                sortBy = option.dataset.sort;
                sortDirection = option.dataset.dir;
                localStorage.setItem('gme_sortBy', sortBy);
                localStorage.setItem('gme_sortDir', sortDirection);
                document.getElementById('sortDropdown').classList.remove('active');
                currentPage = 1;
                renderItems();
            });
        });
        
        document.addEventListener('click', (e) => {
            document.getElementById('sortDropdown').classList.remove('active');
            document.getElementById('currencyDropdown').classList.remove('active');
        });

        loadImages();
        loadData();
    </script>
</body>
</html>
